<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"huamuyichun.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="AFLæºç é˜…è¯»æ˜¯å­¦ä¹ AFLå·¥å…·çš„æœ€å¥½æ–¹æ³•ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="AFLæºç é˜…è¯»">
<meta property="og:url" content="http://huamuyichun.github.io/2024/03/01/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/index.html">
<meta property="og:site_name" content="hmyc_blog">
<meta property="og:description" content="AFLæºç é˜…è¯»æ˜¯å­¦ä¹ AFLå·¥å…·çš„æœ€å¥½æ–¹æ³•ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-03-01T14:49:14.000Z">
<meta property="article:modified_time" content="2024-03-03T04:01:57.716Z">
<meta property="article:author" content="Sparrow">
<meta property="article:tag" content="AFL">
<meta property="article:tag" content="æ¨¡ç³Šæµ‹è¯•">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://huamuyichun.github.io/2024/03/01/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>AFLæºç é˜…è¯» | hmyc_blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hmyc_blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>æ—¥ç¨‹è¡¨</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>ç«™ç‚¹åœ°å›¾</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>å…¬ç›Š 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://huamuyichun.github.io/2024/03/01/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Sparrow">
      <meta itemprop="description" content="ä¸çŸ¥æ‰€æªæ‰æ˜¯äººç”Ÿ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hmyc_blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AFLæºç é˜…è¯»
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-01 22:49:14" itemprop="dateCreated datePublished" datetime="2024-03-01T22:49:14+08:00">2024-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-03-03 12:01:57" itemprop="dateModified" datetime="2024-03-03T12:01:57+08:00">2024-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ </span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/cs/" itemprop="url" rel="index"><span itemprop="name">cs</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/cs/%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">æµ‹è¯•</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/cs/%E6%B5%8B%E8%AF%95/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">æ¨¡ç³Šæµ‹è¯•</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/cs/%E6%B5%8B%E8%AF%95/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/AFL/" itemprop="url" rel="index"><span itemprop="name">AFL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>AFLæºç é˜…è¯»æ˜¯å­¦ä¹ AFLå·¥å…·çš„æœ€å¥½æ–¹æ³•ã€‚</p>
<span id="more"></span>
<p>è¿™æ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡ç‹¬ç«‹é˜…è¯»ä¸­è§„æ¨¡ä»£ç ï¼Œå¯èƒ½ä¼šæœ‰æ‰€ç–æ¼ã€‚<br>ç”±äºä½¿ç”¨çš„å­¦ä¹ æµæ˜¯obï¼Œæ‰€ä»¥ä¼šå‡ºç°ä¸€å®šçš„åŒé“¾ï¼Œå¯ä»¥å¯¹ç€Q&amp;Açœ‹ï¼Œæ‡’å¾—å†ä¿®æ”¹äº†ã€‚</p>
<h1 id="afl-gcc-c"><a href="#afl-gcc-c" class="headerlink" title="afl-gcc.c"></a>afl-gcc.c</h1><h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><p>è¿™ä¸ªå‡½æ•°ç”¨æ¥[[Q&amp;A#ä¸ºä»€ä¹ˆè¦æ‰¾afl-asçš„ä½ç½®ä»¥åŠæ‰¾åˆ°å®ƒä¹‹åçš„ç”¨é€”|å¯»æ‰¾afl-aså¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®]]<br>å¯»æ‰¾<code>afl-as</code>çš„ä½ç½®æ˜¯ä¸ºäº†ç¡®å®šç³»ç»Ÿä¸­<code>afl-as</code>å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºæ’æ¡©äºŒè¿›åˆ¶æ–‡ä»¶çš„æ±‡ç¼–å™¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">find_as</span><span class="params">(u8* argv0)</span> &#123;</span><br><span class="line">  u8 *afl_path = getenv(<span class="string">&quot;AFL_PATH&quot;</span>);<span class="comment">//å°è¯•è·å–ç¯å¢ƒå˜é‡çš„å€¼</span></span><br><span class="line">  u8 *slash, *tmp;</span><br><span class="line">  <span class="keyword">if</span> (afl_path) &#123;</span><br><span class="line">    tmp = alloc_printf(<span class="string">&quot;%s/as&quot;</span>, afl_path);</span><br><span class="line">    <span class="keyword">if</span> (!access(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = afl_path;</span><br><span class="line">      ck_free(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ck_free(tmp);</span><br><span class="line">  &#125;</span><br><span class="line">  slash = <span class="built_in">strrchr</span>(argv0, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (slash) &#123;</span><br><span class="line">    u8 *dir;</span><br><span class="line">    *slash = <span class="number">0</span>;</span><br><span class="line">    dir = ck_strdup(argv0);</span><br><span class="line">    *slash = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    tmp = alloc_printf(<span class="string">&quot;%s/afl-as&quot;</span>, dir);</span><br><span class="line">    <span class="keyword">if</span> (!access(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = dir;</span><br><span class="line">      ck_free(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ck_free(tmp);</span><br><span class="line">    ck_free(dir);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!access(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">    as_path = AFL_PATH;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  FATAL(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸åŒçš„æ–¹æ³•å»æ‰¾<code>afl-as</code>çš„ä½ç½®ã€‚è¿™æ ·çš„è®¾è®¡æ˜¯ä¸ºäº†ç¡®ä¿aflå·¥å…·èƒ½æ‰¾åˆ°è¿™ä¸ªæ±‡ç¼–å™¨ã€‚</p>
<h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯å°†[[Q&amp;A#argvæ˜¯ä»€ä¹ˆ|<code>argv</code>]]æ‹·è´åˆ°<code>cc_params</code>ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†<br>å‡½æ•°æœ¬ä½“å¹¶æ— ç‰¹ç‚¹</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>å®é™…ä¸Šï¼Œ<code>afl-gcc</code>å°±æ˜¯æ‰¾åˆ°<code>as</code>æ‰€åœ¨ä½ç½®ï¼Œå°†å…¶åŠ å…¥æœç´¢è·¯å¾„ï¼Œç„¶åè®¾ç½®å¿…è¦çš„gccå‚æ•°å’Œä¸€äº›å®ï¼Œç„¶åè°ƒç”¨gccè¿›è¡Œå®é™…çš„ç¼–è¯‘ï¼Œä»…ä»…æ˜¯ä¸€å±‚<code>wrapper</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isatty(<span class="number">2</span>) &amp;&amp; !getenv(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(cCYA <span class="string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(</span><br><span class="line">         BIN_PATH, BIN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  find_as(argv[<span class="number">0</span>]);<span class="comment">//æŸ¥æ‰¾fake GNU assembler</span></span><br><span class="line"></span><br><span class="line">  edit_params(argc, argv);<span class="comment">//è®¾ç½®CCçš„å‚æ•°</span></span><br><span class="line"></span><br><span class="line">  execvp(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);<span class="comment">//è°ƒç”¨execvpæ‰§è¡ŒCC</span></span><br><span class="line"></span><br><span class="line">  FATAL(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">[&lt;<span class="number">64</span>;<span class="number">50</span>;<span class="number">20</span>M```</span><br><span class="line">ä¹Ÿå°±æ˜¯è¯´ï¼Œ`afl-gcc`å…¶å®æœ¬èº«é€»è¾‘å¾ˆç®€å•</span><br><span class="line">[&lt;<span class="number">64</span>;<span class="number">50</span>;<span class="number">20</span>M</span><br><span class="line">[&lt;<span class="number">64</span>;<span class="number">49</span>;<span class="number">20</span>M<span class="meta"># afl-as.c</span></span><br><span class="line">### å˜é‡å®šä¹‰</span><br><span class="line">[&lt;<span class="number">64</span>;<span class="number">49</span>;<span class="number">20</span>M```c</span><br><span class="line"><span class="type">static</span> u8** as_params;          <span class="comment">/* Parameters passed to the real &#x27;as&#x27;</span></span><br><span class="line"><span class="comment">[&lt;64;49;20Mä¼ é€’ç»™asçš„å‚æ•°*/</span></span><br><span class="line"></span><br><span class="line">[&lt;<span class="number">64</span>;<span class="number">49</span>;<span class="number">20</span>Mstatic u8*  input_file;         <span class="comment">/* Originally specified input file</span></span><br><span class="line"><span class="comment">è¾“å…¥æ–‡ä»¶*/</span></span><br><span class="line"><span class="type">static</span> u8*  modified_file;      <span class="comment">/* Instrumented file for the real &#x27;as&#x27;</span></span><br><span class="line"><span class="comment">asè¿›è¡Œæ’æ¡©å¤„ç†çš„æ–‡ä»¶ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u8   be_quiet,           <span class="comment">/* Quiet mode (no stderr output)</span></span><br><span class="line"><span class="comment">é™é»˜æ¨¡å¼ï¼Œæ²¡æœ‰æ ‡å‡†è¾“å‡º*/</span></span><br><span class="line">            clang_mode,         <span class="comment">/* Running in clang mode?               */</span></span><br><span class="line">            pass_thru,          <span class="comment">/* Just pass data through?              */</span></span><br><span class="line">            just_version,       <span class="comment">/* Just show version?                   */</span></span><br><span class="line">            sanitizer;          <span class="comment">/* Using ASAN / MSAN                    */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u32  inst_ratio = <span class="number">100</span>,   <span class="comment">/* Instrumentation probability (%)</span></span><br><span class="line"><span class="comment">æ’æ¡©è¦†ç›–ç‡*/</span></span><br><span class="line">            as_par_cnt = <span class="number">1</span>;     <span class="comment">/* Number of params to &#x27;as&#x27;</span></span><br><span class="line"><span class="comment">ä¼ é€’ç»™asçš„å‚æ•°æ•°é‡åˆå§‹å€¼*/</span></span><br></pre></td></tr></table></figure>

<h3 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h3><p>æ£€æŸ¥å¹¶ä¿®æ”¹å‚æ•°ä»¥ä¼ é€’ç»™<code>as</code>ã€‚è¯·æ³¨æ„ï¼Œæ–‡ä»¶åå§‹ç»ˆæ˜¯GCCä¼ é€’çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ä½¿ä»£ç ä¿æŒç®€å•ã€‚<br><strong>ä¸»è¦æ˜¯è®¾ç½®å˜é‡as_paramsçš„å€¼ï¼Œä»¥åŠuse_64bit&#x2F;modified_fileçš„å€¼ã€‚</strong></p>
<h3 id="add-instructmentation"><a href="#add-instructmentation" class="headerlink" title="add_instructmentation"></a>add_instructmentation</h3><p>å¤„ç†è¾“å…¥æ–‡ä»¶ï¼Œç”Ÿæˆ<code>modified_file</code>å°†æ¡©æ’å…¥åˆ°é€‚å½“çš„ä½ç½®<br>åœ¨è¿™é‡Œï¼Œ<code>outf</code>å³ä¸ºè¾“å‡ºæ–‡ä»¶çš„æŒ‡é’ˆ<br>è¿™ä¸€éƒ¨åˆ†æ˜¯æ–‡ä»¶I&#x2F;Oå¤„ç†</p>
<ul>
<li>å¦‚æœinput_fileä¸ä¸ºç©ºï¼Œåˆ™å°è¯•æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ‰“å¼€å¤±è´¥å°±æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯»å–æ ‡å‡†è¾“å…¥ï¼Œæœ€ç»ˆè·å–FILE* æŒ‡é’ˆinf</li>
<li>ç„¶åæ‰“å¼€modified_fileå¯¹åº”çš„ä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶è·å–å…¶[[Q&amp;A#ä»€ä¹ˆå«åšæ–‡ä»¶çš„å¥æŸ„|å¥æŸ„]]outfdï¼Œå†æ ¹æ®å¥æŸ„é€šè¿‡fdopenå‡½æ•°æ‹¿åˆ°FILE* æŒ‡é’ˆout<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (input_file) &#123;</span><br><span class="line"></span><br><span class="line">   inf = fopen(input_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (!inf) PFATAL(<span class="string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">else</span> inf = <span class="built_in">stdin</span>;</span><br><span class="line"></span><br><span class="line"> outfd = open(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);</span><br><span class="line"></span><br><span class="line"> outf = fdopen(outfd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!outf) PFATAL(<span class="string">&quot;fdopen() failed&quot;</span>);</span><br></pre></td></tr></table></figure>
é€šè¿‡fgetsä»infä¸­é€è¡Œè¯»å–å†…å®¹ä¿å­˜åˆ°lineæ•°ç»„é‡Œï¼Œæ¯è¡Œæœ€å¤šè¯»å–çš„å­—èŠ‚æ•°æ˜¯MAX_LINE(8192),è¿™ä¸ªå€¼åŒ…æ‹¬â€™\0â€™,æ‰€ä»¥å®é™…è¯»å–çš„æœ‰å†…å®¹çš„å­—èŠ‚æ•°æ˜¯MAX_LINE-1ä¸ªå­—èŠ‚ã€‚ä»lineæ•°ç»„é‡Œå°†è¯»å–çš„å†…å®¹å†™å…¥åˆ°outfå¯¹åº”çš„æ–‡ä»¶é‡Œ<br>æ¥ä¸‹æ¥æ˜¯æ’æ¡©çš„è¿‡ç¨‹<br>é¦–å…ˆæ¥çœ‹éœ€è¦åœ¨å“ªäº›åœ°æ–¹è¿›è¡Œæ’æ¡©<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»å‡½æ•°å…¥å£ç‚¹</span></span><br><span class="line">^main:      - function entry <span class="title function_">point</span> <span class="params">(always instrumented)</span></span><br><span class="line"><span class="comment">//GCCç¼–è¯‘å™¨çš„åˆ†æ”¯æ ‡ç­¾</span></span><br><span class="line">      ^.L0:       - GCC branch label</span><br><span class="line">      <span class="comment">//Clangç¼–è¯‘å™¨ç”Ÿæˆçš„åˆ†æ”¯æ ‡ç­¾ï¼Œåœ¨Clangæ¨¡å¼ä¸‹</span></span><br><span class="line">      ^.LBB0_0:   - clang branch <span class="title function_">label</span> <span class="params">(but only in clang mode)</span></span><br><span class="line">      <span class="comment">//è¡¨ç¤ºæ¡ä»¶åˆ†æ”¯æŒ‡ä»¤jnz</span></span><br><span class="line">      ^\tjnz foo  - conditional branches</span><br><span class="line"></span><br><span class="line">    ...but not:</span><br><span class="line"></span><br><span class="line">      ^# BB#0:    - clang comments</span><br><span class="line">      ^ # BB#0:   - ditto</span><br><span class="line">      ^.Ltmp0:    - clang non-branch labels</span><br><span class="line">      ^.LC0       - GCC non-branch labels</span><br><span class="line">      ^.LBB0_0:   - <span class="title function_">ditto</span> <span class="params">(when in GCC mode)</span></span><br><span class="line">      ^\tjmp foo  - non-conditional jumps</span><br></pre></td></tr></table></figure>
è¿™äº›åœ°æ–¹æ˜¯æºç ä¸­æåˆ°çš„ï¼Œæœ‰äº›åœ°æ–¹æ’è€Œæœ‰äº›åœ°æ–¹ä¸æ’ã€‚<br>æ³¨æ„ï¼šæ’æ¡©åªå‘[[Q&amp;A#ä»€ä¹ˆå«åšäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ®µï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆ|.text]]æ’<br>å…·ä½“æ’æ¡©é€»è¾‘æœ‰å¾ˆå¤šï¼Œç»†è‡´çš„æ²¡æ€ä¹ˆå…³æ³¨ï¼Œä½†æ˜¯å¤§æ¦‚å›´ç»•ç€ä¸Šé¢çš„åŸåˆ™ï¼Œè¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…å³å¯ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fgets(line, MAX_LINE, inf)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!pass_thru &amp;&amp;</span><br><span class="line">    !skip_intel &amp;&amp;</span><br><span class="line">    !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">        instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"><span class="comment">//å…ˆæ£€æŸ¥å¹¶è·³è¿‡ä¸€äº›æ ‡ç­¾ï¼Œå®ï¼Œæ³¨é‡Šç­‰ä»£ç ï¼Œåˆ¤æ–­å½“å‰è¡Œæ˜¯å¦ä¸ºæ±‡ç¼–æŒ‡ä»¤</span></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              R(MAP_SIZE));</span><br><span class="line"><span class="comment">//fprintfå°±ä¼šåœ¨è¾“å‡ºæ–‡ä»¶ä¸­æ’å…¥ç›¸åº”çš„æ’æ¡©ä»£ç </span></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line"><span class="comment">//æ’æ¡©è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
ç„¶åæ ¹æ®ç›®çš„æ’æ¡©ä½ç½®ï¼Œè¿›è¡Œä¸åŒçš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå¦‚æœæ˜¯ç›®çš„æ¡©ï¼Œåˆ™æ’å…¥å³å¯ã€‚<br>å…¶å®å¯ä»¥çœ‹å‡ºæ¥ï¼Œaflçš„æ’æ¡©é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡æ±‡ç¼–çš„å‰å¯¼å‘½ä»¤æ¥åˆ¤æ–­è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªåˆ†æ”¯æˆ–è€…æ˜¯å‡½æ•°ï¼Œç„¶åæ’æ¡©ã€‚</li>
</ul>
<h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><ul>
<li>è¯»å–ç¯å¢ƒå˜é‡AFL_INST_RATIOçš„å€¼ï¼Œè®¾ç½®ä¸ºinst_ratio_str</li>
<li>è®¾ç½®srandomçš„éšæœºç§å­ä¸º<code>rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();</code></li>
<li>è®¾ç½®ç¯å¢ƒå˜é‡AS_LOOP_ENV_VARçš„å€¼ä¸º1</li>
<li>è¯»å–ç¯å¢ƒå˜é‡[[Q&amp;A#ä»€ä¹ˆæ˜¯ASANæˆ–MSAN|AFL_USE_ASANå’ŒAFL_USE_MSAN]]çš„å€¼ï¼Œå¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªä¸º1ï¼Œåˆ™è®¾ç½®sanitizerä¸º1ï¼Œä¸”å°†inst_ratioé™¤3ã€‚<ul>
<li>è¿™æ˜¯å› ä¸ºAFLæ— æ³•åœ¨æ’æ¡©çš„æ—¶å€™è¯†åˆ«å‡ºASAN specific branchesï¼Œæ‰€ä»¥ä¼šæ’å…¥å¾ˆå¤šæ— æ„ä¹‰çš„æ¡©ï¼Œä¸ºäº†é™ä½è¿™ç§æ¦‚ç‡ï¼Œç²—æš´çš„å°†æ•´ä¸ªæ’æ¡©çš„æ¦‚ç‡éƒ½é™¤ä»¥3</li>
</ul>
</li>
<li>edit_params(argc, argv)</li>
<li>add_instrumentation()</li>
<li>forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œè®©å­è¿›ç¨‹æ¥æ‰§è¡Œ<code>execvp(as_params[0], (char **) as_params);</code><ul>
<li>è¿™å…¶å®æ˜¯å› ä¸ºæˆ‘ä»¬çš„execvpæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šç”¨<code>as_params[0]</code>æ¥å®Œå…¨æ›¿æ¢æ‰å½“å‰è¿›ç¨‹ç©ºé—´ä¸­çš„ç¨‹åºï¼Œå¦‚æœä¸é€šè¿‡å­è¿›ç¨‹æ¥æ‰§è¡Œå®é™…çš„asï¼Œé‚£ä¹ˆåç»­å°±æ— æ³•åœ¨æ‰§è¡Œå®Œå®é™…çš„asä¹‹åï¼Œè¿˜èƒ½unlinkæ‰modified_file</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mickole/p/3187409.html">execç³»åˆ—å‡½æ•°</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/THEONE10211024/article/details/13774669">forkå‡ºçš„å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹</a></li>
</ul>
</li>
<li><code>waitpid(pid, &amp;status, 0)</code>ç­‰å¾…å­è¿›ç¨‹ç»“æŸ</li>
<li>è¯»å–ç¯å¢ƒå˜é‡AFL_KEEP_ASSEMBLYçš„å€¼ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œå°±unlinkæ‰modified_fileã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  s32 pid;</span><br><span class="line">  u32 rand_seed;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  u8* inst_ratio_str = getenv(<span class="string">&quot;AFL_INST_RATIO&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timezone</span> <span class="title">tz</span>;</span></span><br><span class="line"></span><br><span class="line">  clang_mode = !!getenv(CLANG_ENV_VAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isatty(<span class="number">2</span>) &amp;&amp; !getenv(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(cCYA <span class="string">&quot;afl-as &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    gettimeofday(&amp;tv, &amp;tz);</span><br><span class="line"></span><br><span class="line">  rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();</span><br><span class="line"></span><br><span class="line">  srandom(rand_seed);</span><br><span class="line"></span><br><span class="line">  edit_params(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inst_ratio_str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(inst_ratio_str, <span class="string">&quot;%u&quot;</span>, &amp;inst_ratio) != <span class="number">1</span> || inst_ratio &gt; <span class="number">100</span>)</span><br><span class="line">      FATAL(<span class="string">&quot;Bad value of AFL_INST_RATIO (must be between 0 and 100)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getenv(AS_LOOP_ENV_VAR))</span><br><span class="line">    FATAL(<span class="string">&quot;Endless loop when calling &#x27;as&#x27; (remove &#x27;.&#x27; from your PATH)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  setenv(AS_LOOP_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When compiling with ASAN, we don&#x27;t have a particularly elegant way to skip</span></span><br><span class="line"><span class="comment">     ASAN-specific branches. But we can probabilistically compensate for</span></span><br><span class="line"><span class="comment">     that... */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getenv(<span class="string">&quot;AFL_USE_ASAN&quot;</span>) || getenv(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line">    sanitizer = <span class="number">1</span>;</span><br><span class="line">    inst_ratio /= <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!just_version) add_instrumentation();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(pid = fork())) &#123;</span><br><span class="line"></span><br><span class="line">    execvp(as_params[<span class="number">0</span>], (<span class="type">char</span>**)as_params);</span><br><span class="line">    FATAL(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, as_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>) PFATAL(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!getenv(<span class="string">&quot;AFL_KEEP_ASSEMBLY&quot;</span>)) unlink(modified_file);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(WEXITSTATUS(status));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="afl-clang-fast"><a href="#afl-clang-fast" class="headerlink" title="afl-clang-fast"></a>afl-clang-fast</h1><p>å…ˆè·³è¿‡</p>
<h1 id="afl-fuzz-c"><a href="#afl-fuzz-c" class="headerlink" title="afl-fuzz.c"></a>afl-fuzz.c</h1><p>è¯¥éƒ¨åˆ†æ˜¯AFLä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œæ­¤ä¸ºæ¨¡ç³Šå™¨çš„å®ç°éƒ¨åˆ†ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯é€šè¿‡ä¸æ–­å˜å¼‚æµ‹è¯•ç”¨ä¾‹æ¥å½±å“ç¨‹åºçš„æ‰§è¡Œè·¯å¾„</p>
<p>åœ¨åŠŸèƒ½ä¸Šï¼Œå¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>åˆå§‹é…ç½®ï¼Œ</li>
<li>fuzzæ‰§è¡Œ</li>
<li>å˜å¼‚ç­–ç•¥</li>
</ol>
<p>è¯¥æ–‡ä»¶æ¯”è¾ƒé•¿ï¼Œä»mainå¼€å§‹è¯»ï¼Œå‰åŠéƒ¨åˆ†éƒ½åœ¨åšå‚æ•°è§£æçš„å·¥ä½œ</p>
<h3 id="main-2"><a href="#main-2" class="headerlink" title="main"></a>main</h3><p>é…ç½®éƒ¨åˆ†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;+i:o:f:m:b:t:T:dnCB:S:M:x:QV&quot;</span>)) &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>7798-7989è¿™ä¸€éƒ¨åˆ†æ˜¯ä»ç»ˆç«¯è¾“å…¥ä¸­åŒ¹é…<br>7989-8091è¿™ä¸€éƒ¨åˆ†æ˜¯ä¸€äº›é…ç½®ï¼Œå‡†å¤‡å·¥ä½œ<br>å…ˆæŒ‰ç…§é¡ºåºæ¥ï¼Œå†ç»†è®²å„ä¸ªå‡½æ•°ï¼š<br>è°ƒç”¨<code>get_cur_time</code>è·å–å¼€å§‹æ—¶é—´ï¼Œç„¶å<code>perform_dry_run</code>ç”Ÿæˆåˆå§‹åŒ–çš„<code>queue</code>å’Œ<code>bitmap</code>åªå¯¹åˆå§‹æ‰§è¡Œä¸€æ¬¡ã€‚</p>
<h3 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h3><p>è¯¥å‡½æ•°æ˜¯AFLä¸­çš„ä¸€ä¸ªå…³é”®å‡½æ•°ï¼Œä»–ä¼šæ‰§è¡Œinputæ–‡ä»¶å¤¹ä¸‹é¢„å…ˆå‡†å¤‡çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œç”Ÿæˆåˆå§‹åŒ–çš„<code>queue</code>å’Œ<code>bitmap</code>ï¼Œåªå¯¹åˆå§‹æ‰§è¡Œä¸€æ¬¡ã€‚<br>å‡½æ•°æ‰§è¡Œçš„é€»è¾‘å¤§è‡´æ˜¯ï¼šé¦–å…ˆæ‰“å¼€æ–‡ä»¶å¹¶è¯»å–æµ‹è¯•ç”¨ä¾‹ï¼Œè°ƒç”¨<code>calibrate_case</code>è¿›è¡Œæ ¡å‡†ï¼Œç„¶åæ ¹æ®resçš„ç»“æœè¿›è¡Œå¤„ç†ï¼Œæœ€åå†ç»Ÿè®¡è¾“å‡ºã€‚<br>è¯¥å‡½æ•°å¯ä»¥å¸®åŠ©ç”¨æˆ·äº†è§£æµ‹è¯•é›†çš„è´¨é‡å’Œæ€§èƒ½ã€‚</p>
<ol>
<li>è¯»å–ç¯å¢ƒå˜é‡</li>
<li>éå†<code>queue</code> <code>res=calibrate_case(argv,q,use_mem,0,1)</code>æ­¤ä¸ºæ ¡å‡†æµ‹è¯•ç”¨ä¾‹</li>
<li>æ ¹æ®resçš„ç»“æœè¿›è¡Œåˆ¤æ–­ï¼š<ul>
<li>FAULT_NONE<ul>
<li>å¦‚æœqæ˜¯å¤´ç»“ç‚¹ï¼Œå³ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œåˆ™<code>check_map_coverage</code>ï¼Œç”¨ä»¥è¯„ä¼°map coverage<ul>
<li>è®¡æ•°trace_bitså‘ç°çš„è·¯å¾„æ•°ï¼Œå¦‚æœå°äº100ï¼Œå°±ç›´æ¥è¿”å›</li>
<li>åœ¨trace_bitsçš„æ•°ç»„ååŠæ®µï¼Œå¦‚æœæœ‰å€¼å°±ç›´æ¥è¿”å›ã€‚</li>
<li>æŠ›å‡ºè­¦å‘Š<code>WARNF(&quot;Recompile binary with newer version of afl to improve coverage!&quot;)</code></li>
</ul>
</li>
<li>å¦‚æœæ˜¯crash_modeï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œ<code>FATAL(&quot;Test case &#39;%s&#39; does *NOT* crash&quot;, fn);</code>ï¼Œè¯¥æ–‡ä»¶ä¸å´©æºƒ</li>
</ul>
</li>
</ul>
<ul>
<li><ul>
<li>FAULT_TMOUT<ul>
<li>å¦‚æœæŒ‡å®šäº†-tå‚æ•°ï¼Œåˆ™timeout_givenå€¼ä¸º2<ul>
<li>æŠ›å‡ºè­¦å‘Š<code>WARNF(&quot;Test case results in a timeout (skipping)&quot;);</code>ï¼Œå¹¶è®¾ç½®qçš„cal_failedä¸ºCAL_CHANCESï¼Œcal_failuresè®¡æ•°å™¨åŠ ä¸€ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>FAULT_CRASH<ul>
<li>å¦‚æœæ²¡æœ‰æŒ‡å®šmem_limitï¼Œåˆ™å¯èƒ½æŠ›å‡ºå»ºè®®å¢åŠ å†…å­˜çš„å»ºè®®</li>
<li>ä½†ä¸ç®¡æŒ‡å®šäº†è¿˜æ˜¯æ²¡æœ‰ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸<code>FATAL(&quot;Test case &#39;%s&#39; results in a crash&quot;, fn);</code></li>
</ul>
</li>
<li>FAULT_ERROR<ul>
<li>æŠ›å‡ºå¼‚å¸¸<code>Unable to execute target application</code></li>
</ul>
</li>
<li>FAULT_NOINST<ul>
<li>è¿™ä¸ªæ ·ä¾‹è¿è¡Œæ²¡æœ‰å‡ºç°ä»»ä½•è·¯å¾„ä¿¡æ¯ï¼ŒæŠ›å‡ºå¼‚å¸¸<code>No instrumentation detected</code></li>
</ul>
</li>
<li>FAULT_NOBITS<ul>
<li>å¦‚æœè¿™ä¸ªæ ·ä¾‹æœ‰å‡ºç°è·¯å¾„ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•æ–°è·¯å¾„ï¼ŒæŠ›å‡ºè­¦å‘Š<code>WARNF(&quot;No new instrumentation output, test case may be useless.&quot;)</code>ï¼Œè®¤ä¸ºè¿™æ˜¯æ— ç”¨è·¯å¾„ã€‚useless_at_startè®¡æ•°å™¨åŠ ä¸€</li>
</ul>
</li>
<li>å¦‚æœè¿™ä¸ªæ ·ä¾‹qçš„var_behaviorä¸ºçœŸï¼Œåˆ™ä»£è¡¨å®ƒå¤šæ¬¡è¿è¡Œï¼ŒåŒæ ·çš„è¾“å…¥æ¡ä»¶ä¸‹ï¼Œå´å‡ºç°ä¸åŒçš„è¦†ç›–ä¿¡æ¯ã€‚</li>
<li>æŠ›å‡ºè­¦å‘Š<code>WARNF(&quot;Instrumentation output varies across runs.&quot;);</code>ï¼Œä»£è¡¨è¿™ä¸ªæ ·ä¾‹çš„è·¯å¾„è¾“å‡ºå¯å˜</li>
<li>ç„¶åè¯»å–ä¸‹ä¸€ä¸ªqueueï¼Œç»§ç»­æµ‹è¯•ï¼Œç›´åˆ°ç»“æŸã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">perform_dry_run</span><span class="params">(<span class="type">char</span>** argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">queue_entry</span>* <span class="title">q</span> =</span> <span class="built_in">queue</span>;</span><br><span class="line">  u32 cal_failures = <span class="number">0</span>;</span><br><span class="line">  u8* skip_crashes = getenv(<span class="string">&quot;AFL_SKIP_CRASHES&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line"></span><br><span class="line">    u8* use_mem;</span><br><span class="line">    u8  res;</span><br><span class="line">    s32 fd;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">strrchr</span>(q-&gt;fname, <span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ACTF(<span class="string">&quot;Attempting dry run with &#x27;%s&#x27;...&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    fd = open(q-&gt;fname, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, q-&gt;fname);</span><br><span class="line"></span><br><span class="line">    use_mem = ck_alloc_nozero(q-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, use_mem, q-&gt;len) != q-&gt;len)</span><br><span class="line">      FATAL(<span class="string">&quot;Short read from &#x27;%s&#x27;&quot;</span>, q-&gt;fname);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    res = calibrate_case(argv, q, use_mem, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    ck_free(use_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == crash_mode || res == FAULT_NOBITS)</span><br><span class="line">      SAYF(cGRA <span class="string">&quot;    len = %u, map size = %u, exec speed = %llu us\n&quot;</span> cRST,</span><br><span class="line">           q-&gt;len, q-&gt;bitmap_size, q-&gt;exec_us);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (res) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> FAULT_NONE:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (q == <span class="built_in">queue</span>) check_map_coverage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crash_mode) FATAL(<span class="string">&quot;Test case &#x27;%s&#x27; does *NOT* crash&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> FAULT_TMOUT:</span><br><span class="line">      <span class="keyword">if</span> (timeout_given &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            WARNF(<span class="string">&quot;Test case results in a timeout (skipping)&quot;</span>);</span><br><span class="line">            q-&gt;cal_failed = CAL_CHANCES;</span><br><span class="line">            cal_failures++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> FAULT_CRASH:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crash_mode) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skip_crashes) &#123;</span><br><span class="line">          WARNF(<span class="string">&quot;Test case results in a crash (skipping)&quot;</span>);</span><br><span class="line">          q-&gt;cal_failed = CAL_CHANCES;</span><br><span class="line">          cal_failures++;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> FAULT_ERROR:</span><br><span class="line"></span><br><span class="line">        FATAL(<span class="string">&quot;Unable to execute target application (&#x27;%s&#x27;)&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> FAULT_NOINST:</span><br><span class="line"></span><br><span class="line">        FATAL(<span class="string">&quot;No instrumentation detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> FAULT_NOBITS:</span><br><span class="line"></span><br><span class="line">        useless_at_start++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_bitmap &amp;&amp; !shuffle_queue)</span><br><span class="line">          WARNF(<span class="string">&quot;No new instrumentation output, test case may be useless.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (q-&gt;var_behavior) WARNF(<span class="string">&quot;Instrumentation output varies across runs.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    q = q-&gt;next;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cal_failures) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cal_failures == queued_paths)</span><br><span class="line">      FATAL(<span class="string">&quot;All test cases time out%s, giving up!&quot;</span>,</span><br><span class="line">            skip_crashes ? <span class="string">&quot; or crash&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    WARNF(<span class="string">&quot;Skipped %u test cases (%0.02f%%) due to timeouts%s.&quot;</span>, cal_failures,</span><br><span class="line">          ((<span class="type">double</span>)cal_failures) * <span class="number">100</span> / queued_paths,</span><br><span class="line">          skip_crashes ? <span class="string">&quot; or crashes&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cal_failures * <span class="number">5</span> &gt; queued_paths)</span><br><span class="line">      WARNF(cLRD <span class="string">&quot;High percentage of rejected test cases, check settings!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  OKF(<span class="string">&quot;All test cases processed.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h3><p>è¯¥å‡½æ•°ç”¨äºæ–°æµ‹è¯•ç”¨ä¾‹çš„æ ¡å‡†ï¼Œåœ¨å¤„ç†è¾“å…¥ç›®å½•æ—¶æ‰§è¡Œã€‚<br>è¯¥å‡½æ•°çš„ä¸»è¦ç”¨é€”æ˜¯åˆå§‹åŒ–å¹¶å¯åŠ¨fork server</p>
<h3 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h3><p>æ¯å½“æˆ‘ä»¬å‘ç°ä¸€ä¸ªæ–°çš„è·¯å¾„ï¼Œå°±éœ€è¦åˆ¤æ–­å‘ç°çš„è·¯å¾„æ˜¯å¦æ›´â€favorableâ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯å¦åŒ…å«æ›´å°çš„è·¯å¾„é›†åˆï¼Œèƒ½éå†åˆ°æ‰€æœ‰[[Q&amp;A#fuzzæ‰€ç»´æŠ¤çš„bitmap|bitmap]]çš„ä½ï¼Œå¹¶åœ¨fuzzçš„è¿‡ç¨‹ä¸­èšç„¦åœ¨è¿™äº›è·¯å¾„ä¸Š<br>ä»¥ä¸Šè¿‡ç¨‹çš„ç¬¬ä¸€æ­¥æ˜¯ä¸ºbitmapä¸­çš„æ¯ä¸ªå­—èŠ‚ç»´æŠ¤ä¸€ä¸ª<code>top_rated[]</code>çš„åˆ—è¡¨ï¼Œè¿™é‡Œä¼šè®¡ç®—ç©¶ç«Ÿå“ªäº›ä½ç½®æ˜¯æ›´â€œåˆé€‚â€çš„ï¼Œè¯¥å‡½æ•°ä¸»è¦å®ç°è¯¥è¿‡ç¨‹ã€‚</p>
<p>è¯¥å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œé¦–å…ˆå…ˆæ ¹æ®æ‰§è¡Œæ—¶é—´å’Œæ–‡ä»¶é•¿åº¦å†³å®š<code>fav_factor</code>ä¹Ÿå°±æ˜¯æƒé‡ã€‚ç„¶åéå†<code>bitmap</code>ï¼Œå¦‚æœ<code>trace_bit[i]==1</code>å³è¯¥ä»£ç å—è¢«æ‰§è¡Œè¿‡åˆ™è€ƒå¯Ÿ<code>top_rated[]</code>æ¯”è¾ƒå½“å‰çš„æƒé‡å’Œå·²æœ‰çš„æƒé‡ï¼Œå¦‚æœ<code>top_rated[]</code>çš„æƒé‡æ›´å°ï¼Œåˆ™æ„å‘³ç€åŸå€¼æ›´ä¼˜ï¼Œå¦åˆ™åä¹‹ï¼Œæ›´æ–°å³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">update_bitmap_score</span><span class="params">(<span class="keyword">struct</span> queue_entry* q)</span> &#123;</span><br><span class="line"></span><br><span class="line">  u32 i;</span><br><span class="line">  u64 fav_factor = q-&gt;exec_us * q-&gt;len;<span class="comment">//æ‰§è¡Œæ—¶é—´å’Œæ–‡ä»¶å¤§å°</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* For every byte set in trace_bits[], see if there is a previous winner,</span></span><br><span class="line"><span class="comment">     and how it compares to us. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trace_bits[i]) &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (top_rated[i]) &#123;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* Faster-executing or smaller test cases are favored. */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (fav_factor &gt; top_rated[i]-&gt;exec_us * top_rated[i]-&gt;len) <span class="keyword">continue</span>;<span class="comment">//åŸå€¼æ›´ä¼˜ä¸æ›´æ–°</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">/* Looks like we&#x27;re going to win. Decrease ref count for the</span></span><br><span class="line"><span class="comment">            previous winner, discard its trace_bits[] if necessary. */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!--top_rated[i]-&gt;tc_ref) &#123;</span><br><span class="line">           ck_free(top_rated[i]-&gt;trace_mini);</span><br><span class="line">           top_rated[i]-&gt;trace_mini = <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* Insert ourselves as the new winner. */</span></span><br><span class="line"></span><br><span class="line">       top_rated[i] = q;<span class="comment">//å½“å‰å€¼æ›´ä¼˜ï¼Œæ›´æ–°ã€‚</span></span><br><span class="line">       q-&gt;tc_ref++;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!q-&gt;trace_mini) &#123;</span><br><span class="line">         q-&gt;trace_mini = ck_alloc(MAP_SIZE &gt;&gt; <span class="number">3</span>);</span><br><span class="line">         minimize_bits(q-&gt;trace_mini, trace_bits);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       score_changed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="fuzzæ‰§è¡Œ"><a href="#fuzzæ‰§è¡Œ" class="headerlink" title="fuzzæ‰§è¡Œ"></a>fuzzæ‰§è¡Œ</h2><p>ä¸»å¾ªç¯åœ¨8091å¼€å§‹<br>åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸»å¾ªç¯å‰ï¼Œä¸»å¾ªç¯ä¸­ï¼Œä¸»å¾ªç¯å</p>
<h3 id="cull-queue-ä¸»å¾ªç¯å‰"><a href="#cull-queue-ä¸»å¾ªç¯å‰" class="headerlink" title="cull_queue(ä¸»å¾ªç¯å‰)"></a>cull_queue(ä¸»å¾ªç¯å‰)</h3><p>æ ¹æ®å½“å‰çš„<code>bitmap</code>çš„ä¿¡æ¯ï¼Œæ ‡è®°å“ªäº›æµ‹è¯•ç”¨ä¾‹æ˜¯æœ‰åˆ©çš„ï¼Œå“ªäº›æ˜¯å†—ä½™çš„ã€‚ç„¶åå°½é‡å‰”é™¤å†—ä½™çš„ï¼Œç•™ä¸‹æœ‰åˆ©çš„ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼šç²¾ç®€é˜Ÿåˆ—ã€‚</p>
<ul>
<li>å¦‚æœscore_changedä¸º0ï¼Œå³top_ratedæ²¡æœ‰å˜åŒ–ï¼Œæˆ–è€…dumb_mode,å°±ç›´æ¥è¿”å›</li>
<li>è®¾ç½®score_changedçš„å€¼ä¸º0</li>
<li>åˆ›å»ºu8 temp_væ•°ç»„ï¼Œå¤§å°ä¸º<code>MAP_SIZEé™¤8</code>ï¼Œå¹¶å°†å…¶åˆå§‹å€¼è®¾ç½®ä¸º0xffï¼Œå…¶æ¯ä½å¦‚æœä¸º1å°±ä»£è¡¨è¿˜æ²¡æœ‰è¢«è¦†ç›–åˆ°ï¼Œå¦‚æœä¸º0å°±ä»£è¡¨ä»¥åŠè¢«è¦†ç›–åˆ°äº†ã€‚</li>
<li>è®¾ç½®queued_favoredä¸º0ï¼Œpending_favoredä¸º0</li>
<li>å¼€å§‹éå†queueé˜Ÿåˆ—ï¼Œè®¾ç½®å…¶favoredçš„å€¼éƒ½ä¸º0</li>
<li>å°†iä»0åˆ°MAP_SIZEè¿­ä»£ï¼Œè¿™ä¸ªè¿­ä»£å…¶å®å°±æ˜¯ç­›é€‰å‡ºä¸€ç»„queue entryï¼Œå®ƒä»¬å°±èƒ½å¤Ÿè¦†ç›–åˆ°æ‰€æœ‰ç°åœ¨å·²ç»è¦†ç›–åˆ°çš„è·¯å¾„ï¼Œè€Œä¸”è¿™ä¸ªcaseé›†åˆé‡Œçš„caseè¦æ›´å°æ›´å¿«ï¼Œè¿™å¹¶ä¸æ˜¯æœ€ä¼˜ç®—æ³•ï¼Œåªèƒ½ç®—æ˜¯è´ªå©ªç®—æ³•ã€‚<ul>
<li>è¿™åˆæ˜¯ä¸ªä¸å¥½æ‡‚çš„ä½è¿ç®—ï¼Œ<code>temp_v[i &gt;&gt; 3] &amp; (1 &lt;&lt; (i &amp; 7))</code>ä¸ä¸Šé¢çš„å·®ä¸å¤šï¼Œä¸­é—´çš„æˆ–è¿ç®—æ”¹æˆäº†ä¸ï¼Œæ˜¯ä¸ºäº†æ£€æŸ¥è¯¥ä½æ˜¯ä¸æ˜¯0ï¼Œå³åˆ¤æ–­è¯¥pathå¯¹åº”çš„bitæœ‰æ²¡æœ‰è¢«ç½®ä½ã€‚</li>
</ul>
</li>
<li>å¦‚æœ<code>top_rated[i]</code>æœ‰å€¼ï¼Œä¸”è¯¥pathåœ¨temp_vé‡Œè¢«ç½®ä½<ul>
<li>å°±ä»temp_vä¸­æ¸…é™¤æ‰æ‰€æœ‰<code>top_rated[i]</code>è¦†ç›–åˆ°çš„pathï¼Œå°†å¯¹åº”çš„bitç½®ä¸º0</li>
<li>è®¾ç½®<code>top_rated[i]-&gt;favored</code>ä¸º1ï¼Œqueued_favoredè®¡æ•°å™¨åŠ ä¸€</li>
<li>å¦‚æœ<code>top_rated[i]</code>çš„was_fuzzedå­—æ®µæ˜¯0ï¼Œä»£è¡¨å…¶è¿˜æ²¡æœ‰fuzzè¿‡ï¼Œåˆ™å°†pending_favoredè®¡æ•°å™¨åŠ ä¸€</li>
</ul>
</li>
<li>éå†queueé˜Ÿåˆ—<ul>
<li>mark_as_redundant(q, !q-&gt;favored)<ul>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸æ˜¯favoredçš„caseï¼Œå°±è¢«æ ‡è®°æˆredundant_edges</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cull_queue</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">queue_entry</span>* <span class="title">q</span>;</span></span><br><span class="line">  <span class="type">static</span> u8 temp_v[MAP_SIZE &gt;&gt; <span class="number">3</span>];</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode || !score_changed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  score_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(temp_v, <span class="number">255</span>, MAP_SIZE &gt;&gt; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  queued_favored  = <span class="number">0</span>;</span><br><span class="line">  pending_favored = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  q = <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line">    q-&gt;favored = <span class="number">0</span>;</span><br><span class="line">    q = q-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let&#x27;s see if anything in the bitmap isn&#x27;t captured in temp_v.</span></span><br><span class="line"><span class="comment">     If yes, and if it has a top_rated[] contender, let&#x27;s use it. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line">    <span class="keyword">if</span> (top_rated[i] &amp;&amp; (temp_v[i &gt;&gt; <span class="number">3</span>] &amp; (<span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>)))) &#123;</span><br><span class="line"></span><br><span class="line">      u32 j = MAP_SIZE &gt;&gt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Remove all bits belonging to the current entry from temp_v. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (j--) </span><br><span class="line">        <span class="keyword">if</span> (top_rated[i]-&gt;trace_mini[j])</span><br><span class="line">          temp_v[j] &amp;= ~top_rated[i]-&gt;trace_mini[j];</span><br><span class="line"></span><br><span class="line">      top_rated[i]-&gt;favored = <span class="number">1</span>;</span><br><span class="line">      queued_favored++;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!top_rated[i]-&gt;was_fuzzed) pending_favored++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  q = <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (q) &#123;</span><br><span class="line">    mark_as_redundant(q, !q-&gt;favored);</span><br><span class="line">    q = q-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å­æ›´å¥½ç†è§£ï¼š<br>ç°å‡è®¾æœ‰å¦‚ä¸‹tupleå’Œseedä¿¡æ¯ï¼š</p>
<ul>
<li><strong>tuple</strong>: t0, t1, t2, t3, t4</li>
<li><strong>seed</strong>: s0, s1, s2</li>
<li>åˆå§‹åŒ–<code>temp_v = [1,1,1,1,1]</code></li>
<li>s1å¯è¦†ç›–t2, t3ï¼Œs2è¦†ç›–t0, t1, t4ï¼Œå¹¶ä¸”top_rated[0] &#x3D; s2ï¼Œtop_rated[2]&#x3D;s1<br>å°†æŒ‰ç…§å¦‚ä¸‹è¿‡ç¨‹è¿›è¡Œç­›é€‰å’Œåˆ¤æ–­ï¼š</li>
</ul>
<ol>
<li>é¦–å…ˆåˆ¤æ–­ temp_v[0]&#x3D;1ï¼Œè¯´æ˜t0æ²¡æœ‰è¢«è¦†ç›–ï¼›</li>
<li>top_rated[0] å­˜åœ¨ (s2) -&gt; åˆ¤æ–­s2å¯ä»¥è¦†ç›–çš„èŒƒå›´ -&gt;<code>trace_mini = [1,1,0,0,1]</code>ï¼›</li>
<li>æ›´æ–°<code>temp_v=[0,0,1,1,0]</code>ï¼Œ æ ‡è®°s2ä¸º â€œfavoredâ€ï¼›</li>
<li>ç»§ç»­åˆ¤æ–­ temp_v[1]&#x3D;0ï¼Œè¯´æ˜t1æ­¤æ—¶å·²ç»è¢«è¦†ç›–ï¼Œè·³è¿‡ï¼›</li>
<li>ç»§ç»­åˆ¤æ–­ temp_v[2]&#x3D;1ï¼Œè¯´æ˜t2æ²¡æœ‰è¢«è¦†ç›–ï¼›</li>
<li>top_rated[2] å­˜åœ¨ (s1) -&gt; åˆ¤æ–­s1å¯ä»¥è¦†ç›–çš„èŒƒå›´ -&gt;<code>trace_mini=[0,0,1,1,0]</code>ï¼›</li>
<li>æ›´æ–°<code>temp_v=[0,0,0,0,0]</code>ï¼Œæ ‡è®°s1ä¸º â€œfavoredâ€ï¼›</li>
<li>æ­¤æ—¶æ‰€æœ‰tupleéƒ½è¢«è¦†ç›–ï¼Œå…·å¤‡â€favoredâ€™æ ‡è®°çš„ä¸ºs1, s2ï¼Œè¿‡ç¨‹ç»“æŸã€‚</li>
</ol>
<h3 id="ä¸»å¾ªç¯-8091"><a href="#ä¸»å¾ªç¯-8091" class="headerlink" title="ä¸»å¾ªç¯(8091)"></a>ä¸»å¾ªç¯(8091)</h3><p>ä¸»å¾ªç¯æ‰€ä½œçš„äº‹æƒ…å°±æ˜¯å˜å¼‚ï¼Œæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œè¯„ä¼°æµ‹è¯•ç»“æœï¼Œå’Œæ›´æ–°é˜Ÿåˆ—ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">   u8 skipped_fuzz;</span><br><span class="line"></span><br><span class="line">   cull_queue();<span class="comment">//å…ˆç²¾ç®€é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!queue_cur) &#123;<span class="comment">//è¿™ä¸€éƒ¨åˆ†æ˜¯é˜Ÿåˆ—å¤„ç†ï¼Œå¦‚æœå·²ç»åšå®Œä¸€è½®</span></span><br><span class="line"></span><br><span class="line">     queue_cycle++;<span class="comment">//è½®æ•°++</span></span><br><span class="line">     current_entry     = <span class="number">0</span>;</span><br><span class="line">     cur_skipped_paths = <span class="number">0</span>;</span><br><span class="line">     queue_cur         = <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span> (seek_to) &#123;<span class="comment">//å°†curæŒ‡é’ˆæŒ‡åˆ°é˜Ÿåˆ—ä¸­çš„å…·ä½“ä½ç½®ã€‚</span></span><br><span class="line">       current_entry++;</span><br><span class="line">       seek_to--;</span><br><span class="line">       queue_cur = queue_cur-&gt;next;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     show_stats();<span class="comment">//æ˜¾ç¤ºfuzzingçš„è¿›åº¦ï¼Œä¸æ˜¯é€»è¾‘éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (not_on_tty) &#123;<span class="comment">//éç»ˆç«¯æ¨¡å¼æ—¶ï¼Œä¸æ˜¯é€»è¾‘éƒ¨åˆ†</span></span><br><span class="line">       ACTF(<span class="string">&quot;Entering queue cycle %llu.&quot;</span>, queue_cycle);</span><br><span class="line">       fflush(<span class="built_in">stdout</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* If we had a full queue cycle with no new finds, try</span></span><br><span class="line"><span class="comment">        recombination strategies next. */</span></span><br><span class="line">  <span class="comment">//ä½¿ç”¨recombinationç­–ç•¥</span></span><br><span class="line">     <span class="keyword">if</span> (queued_paths == prev_queued) &#123;<span class="comment">//å¾ªç¯è®¡æ•°ï¼Œå®Œæ•´è·‘äº†ä¸€æ¬¡è€Œæ²¡æœ‰æ–°è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (use_splicing) cycles_wo_finds++; <span class="keyword">else</span> use_splicing = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> cycles_wo_finds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     prev_queued = queued_paths;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (sync_id &amp;&amp; queue_cycle == <span class="number">1</span> &amp;&amp; getenv(<span class="string">&quot;AFL_IMPORT_FIRST&quot;</span>))</span><br><span class="line">       sync_fuzzers(use_argv);<span class="comment">//åŒæ­¥æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//è¯¥å‡½æ•°ä»é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è¿›è¡Œå˜å¼‚å’Œæ‰§è¡Œã€‚</span></span><br><span class="line">   skipped_fuzz = fuzz_one(use_argv);<span class="comment">//è¿›è¡Œä¸€æ¬¡æ¨¡ç³Šæµ‹è¯•</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;<span class="comment">//å†æ¬¡åŒæ­¥</span></span><br><span class="line">     </span><br><span class="line">     <span class="keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))</span><br><span class="line">       sync_fuzzers(use_argv);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!stop_soon &amp;&amp; exit_1) stop_soon = <span class="number">2</span>;<span class="comment">//stop</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (stop_soon) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">   queue_cur = queue_cur-&gt;next;<span class="comment">//æ›´æ–°é˜Ÿåˆ—æŒ‡é’ˆ</span></span><br><span class="line">   current_entry++;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å¯ä»¥é€šè¿‡æºç çœ‹å‡ºæ¥ï¼Œä¸»å¾ªç¯çš„é€»è¾‘å…¶å®è¿˜ç®—ç®€æ´ã€‚</p>
<h3 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h3><p>è¯¥å‡½æ•°æ˜¯æ‰§è¡Œï¼Œå˜å¼‚çš„å…³é”®å‡½æ•°ã€‚ä¹Ÿæ˜¯æœ€é‡è¦çš„å‡½æ•°ã€‚5003-6690<br>åœ¨è¿™é‡Œï¼Œéœ€è¦ç»“åˆ[[ç™½çš®ä¹¦#5. æ¨¡ç³Šæµ‹è¯•ç­–ç•¥ï¼ˆå˜å¼‚ç­–ç•¥ï¼‰|ç™½çš®ä¹¦ä¸Šçš„å˜å¼‚ç­–ç•¥æ¥çœ‹]]ï¼Œä¸¤å¤§ç§å˜å¼‚ç­–ç•¥ï¼Œç¡®å®šæ€§å’Œéç¡®å®šæ€§ã€‚<br>å°†è¿™å¤§å‹å‡½æ•°åˆ†æ²»æ¥çœ‹ï¼Œå‰åŠéƒ¨åˆ†æ˜¯å‡†å¤‡ï¼ŒååŠéƒ¨åˆ†æ‰æ˜¯å˜å¼‚å¤„ç†ã€‚<br>å‰åŠéƒ¨åˆ†ï¼š</p>
<ol>
<li>æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œå¯¹å½“å‰æµ‹è¯•ç”¨ä¾‹æœ‰æ¦‚ç‡ç›´æ¥è¿”å›ï¼ˆä¸ªäººç†è§£åº”è¯¥æ˜¯ä¸ºäº†åŠ é€Ÿï¼‰æ ¹æ®æ˜¯å¦æœ‰<code>pending_favored</code>å’Œ<code>queue_cur</code>çš„æƒ…å†µï¼ŒæŒ‰ç…§æ¦‚ç‡è¿›è¡Œè·³è¿‡ï¼›æœ‰<code>pending_favored</code>, å¯¹äºå·²ç»fuzzè¿‡çš„æˆ–è€…non-favoredçš„æœ‰99%çš„æ¦‚ç‡è·³è¿‡ï¼›æ— pending_favoredï¼Œ95%è·³è¿‡fuzzed&amp;non-favoredï¼Œ75%è·³è¿‡not fuzzed&amp;non-favoredï¼Œä¸è·³è¿‡favoredï¼›<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pending_favored) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If we have any favored, non-fuzzed new arrivals in the queue,</span></span><br><span class="line"><span class="comment">     possibly skip to them at the expense of already-fuzzed or non-favored</span></span><br><span class="line"><span class="comment">     cases. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((queue_cur-&gt;was_fuzzed || !queue_cur-&gt;favored) &amp;&amp;</span><br><span class="line">      UR(<span class="number">100</span>) &lt; SKIP_TO_NEW_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;favored &amp;&amp; queued_paths &gt; <span class="number">10</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Otherwise, still possibly skip non-favored cases, albeit less often.</span></span><br><span class="line"><span class="comment">     The odds of skipping stuff are higher for already-fuzzed inputs and</span></span><br><span class="line"><span class="comment">     lower for never-fuzzed entries. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cycle &gt; <span class="number">1</span> &amp;&amp; !queue_cur-&gt;was_fuzzed) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (UR(<span class="number">100</span>) &lt; SKIP_NFAV_NEW_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (UR(<span class="number">100</span>) &lt; SKIP_NFAV_OLD_PROB) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>ç”¨äºåˆå§‹åŒ–æµ‹è¯•ç”¨ä¾‹å’Œè¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œã€‚ä¸æ˜¯é€»è¾‘é‡ç‚¹ä¸è´´ä»£ç </li>
<li>å¤„ç†æµ‹è¯•ç”¨ä¾‹åœ¨æ ¡å‡†é˜¶æ®µå¤±è´¥çš„æƒ…å†µï¼Œé€šè¿‡é‡ç½® <code>exec_cksum</code> é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œé¿å…ä½¿ç”¨æ— æ•ˆçš„ <code>trace_bits</code> è¿›è¡Œæ¨¡ç³Šæµ‹è¯•<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (queue_cur-&gt;cal_failed) &#123;</span><br><span class="line"></span><br><span class="line">  u8 res = FAULT_TMOUT;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;cal_failed &lt; CAL_CHANCES) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reset exec_cksum to tell calibrate_case to re-execute the testcase</span></span><br><span class="line"><span class="comment">       avoiding the usage of an invalid trace_bits.</span></span><br><span class="line"><span class="comment">       For more info: https://github.com/AFLplusplus/AFLplusplus/pull/425 */</span></span><br><span class="line"></span><br><span class="line">    queue_cur-&gt;exec_cksum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    res = calibrate_case(argv, queue_cur, in_buf, queue_cycle - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">      FATAL(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stop_soon || res != crash_mode) &#123;</span><br><span class="line">    cur_skipped_paths++;</span><br><span class="line">    <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œä¿®å‰ªï¼Œè°ƒç”¨<code>trim_case</code>å‡½æ•°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;trim_done) &#123;</span><br><span class="line"></span><br><span class="line">  u8 res = trim_case(argv, queue_cur, in_buf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">    FATAL(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stop_soon) &#123;</span><br><span class="line">    cur_skipped_paths++;</span><br><span class="line">    <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Don&#x27;t retry trimming, even if it failed. */</span></span><br><span class="line"></span><br><span class="line">  queue_cur-&gt;trim_done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len != queue_cur-&gt;len) len = queue_cur-&gt;len;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒç”¨<code>calculate_score</code>å‡½æ•°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">orig_perf = perf_score = calculate_score(queue_cur);</span><br><span class="line"><span class="comment">/* Skip right away if -d is given, if we have done deterministic fuzzing on this entry ourselves (was_fuzzed), or if it has gone through deterministic testing in earlier, resumed runs (passed_det). */</span></span><br><span class="line"><span class="keyword">if</span> (skip_deterministic || queue_cur-&gt;was_fuzzed || queue_cur-&gt;passed_det)</span><br><span class="line">  <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Skip deterministic fuzzing if exec path checksum puts this out of scope for this master instance. */</span></span><br><span class="line"><span class="comment">//å¦‚æœå·²ç»å®Œæˆäº†deterministicé˜¶æ®µï¼Œåˆ™ç›´æ¥è¿›è¡Œhavoc</span></span><br><span class="line"><span class="keyword">if</span> (master_max &amp;&amp; (queue_cur-&gt;exec_cksum % master_max) != master_id - <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line">doing_det = <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>è‡³æ­¤ï¼Œå‰åŠéƒ¨åˆ†çš„å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼Œä¸‹é¢å¼€å§‹è¿›è¡Œå˜å¼‚ã€‚</p>
<ul>
<li><strong>SIMPLE BITFLIP (+dictionary construction)é˜¶æ®µ</strong>ï¼ŒæŒ‰ä½ç¿»è½¬ï¼Œæ ¹æ®ç¿»è½¬é‡&#x2F;æ­¥é•¿ï¼ŒæŒ‰ä½ç¿»è½¬çš„ç­–ç•¥æœ‰ä»¥ä¸‹å‡ ç§<br>bitflip 1&#x2F;1ï¼Œæ¯æ¬¡ç¿»è½¬1ä¸ªbitï¼ŒæŒ‰ç…§æ¯1ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹<br>bitflip 2&#x2F;1ï¼Œæ¯æ¬¡ç¿»è½¬ç›¸é‚»çš„2ä¸ªbitï¼ŒæŒ‰ç…§æ¯1ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹<br>bitflip 4&#x2F;1ï¼Œæ¯æ¬¡ç¿»è½¬ç›¸é‚»çš„4ä¸ªbitï¼ŒæŒ‰ç…§æ¯1ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹<br>bitflip 8&#x2F;8ï¼Œæ¯æ¬¡ç¿»è½¬ç›¸é‚»çš„8ä¸ªbitï¼ŒæŒ‰ç…§æ¯8ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³ä¾æ¬¡å¯¹æ¯ä¸ªbyteåšç¿»è½¬<br>bitflip 16&#x2F;8ï¼Œæ¯æ¬¡ç¿»è½¬ç›¸é‚»çš„16ä¸ªbitï¼ŒæŒ‰ç…§æ¯8ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³ä¾æ¬¡å¯¹æ¯ä¸ªwordåšç¿»è½¬<br>bitflip 32&#x2F;8ï¼Œæ¯æ¬¡ç¿»è½¬ç›¸é‚»çš„32ä¸ªbitï¼ŒæŒ‰ç…§æ¯8ä¸ªbitçš„æ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³ä¾æ¬¡å¯¹æ¯ä¸ªdwordåšç¿»è½¬</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">define <span class="title function_">FLIP_BIT</span><span class="params">(_ar, _b)</span> <span class="keyword">do</span> &#123; \ <span class="comment">//è¿™ä¸ªå‡½æ•°æ˜¯ç¿»è½¬ç‰¹å®šä½çš„bit</span></span><br><span class="line">    u8* _arf = (u8*)(_ar); \</span><br><span class="line">    u32 _bf = (_b); \</span><br><span class="line">    _arf[(_bf) &gt;&gt; <span class="number">3</span>] ^= (<span class="number">128</span> &gt;&gt; ((_bf) &amp; <span class="number">7</span>)); \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  stage_short = <span class="string">&quot;flip1&quot;</span>;<span class="comment">//å½“å‰å˜å¼‚é˜¶æ®µçš„ç®€ç§°</span></span><br><span class="line">  stage_max   = len &lt;&lt; <span class="number">3</span>;<span class="comment">//å˜å¼‚çš„æ¬¡æ•°</span></span><br><span class="line">  stage_name  = <span class="string">&quot;bitflip 1/1&quot;</span>;<span class="comment">//åç§°</span></span><br><span class="line"></span><br><span class="line">  stage_val_type = STAGE_VAL_NONE;</span><br><span class="line"></span><br><span class="line">  orig_hit_cnt = queued_paths + unique_crashes;</span><br><span class="line"></span><br><span class="line">  prev_cksum = queue_cur-&gt;exec_cksum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++) &#123;<span class="comment">//éå†ä½</span></span><br><span class="line"></span><br><span class="line">    stage_cur_byte = stage_cur &gt;&gt; <span class="number">3</span>;<span class="comment">//å½“å‰æ­¥æ•°è½¬æ¢ä½å­—èŠ‚ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);<span class="comment">//ç¿»è½¬</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);<span class="comment">//æ¢å¤</span></span><br></pre></td></tr></table></figure>
<p>åœ¨bitflip1&#x2F;1ä¸­è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯å®ç°å¯»æ‰¾token</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!dumb_mode &amp;&amp; (stage_cur &amp; <span class="number">7</span>) == <span class="number">7</span>) &#123;<span class="comment">//æ¯ç¿»è½¬å…«æ¬¡è¿›å…¥è¯¥é˜¶æ®µ</span></span><br><span class="line"></span><br><span class="line">      u32 cksum = hash32(trace_bits, MAP_SIZE, HASH_CONST);<span class="comment">//è®¡ç®—traceæ ¡éªŒå’Œ</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stage_cur == stage_max - <span class="number">1</span> &amp;&amp; cksum == prev_cksum) &#123;<span class="comment">//å¦‚æœæŠµè¾¾æ–‡ä»¶æœ«å°¾ä½†æ˜¯æ ¡éªŒå’Œæ²¡æœ‰å‘ç”Ÿæ”¹å˜</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If at end of file and we are still collecting a string, grab the</span></span><br><span class="line"><span class="comment">           final character and force output. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a_len &lt; MAX_AUTO_EXTRA) a_collect[a_len] = out_buf[stage_cur &gt;&gt; <span class="number">3</span>];</span><br><span class="line">        a_len++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">          maybe_add_auto(a_collect, a_len);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cksum != prev_cksum) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Otherwise, if the checksum has changed, see if we have something</span></span><br><span class="line"><span class="comment">           worthwhile queued up, and collect that if the answer is yes. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a_len &gt;= MIN_AUTO_EXTRA &amp;&amp; a_len &lt;= MAX_AUTO_EXTRA)<span class="comment">//å¦‚æœæŒ‰ä½ç¿»è½¬å®é™…ä¸Šæ”¹å˜äº†æ ¡éªŒå’Œå³æ‰§è¡Œè·¯å¾„å‘ç”Ÿå˜åŒ–</span></span><br><span class="line">          maybe_add_auto(a_collect, a_len);</span><br><span class="line"></span><br><span class="line">        a_len = <span class="number">0</span>;</span><br><span class="line">        prev_cksum = cksum;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Continue collecting string, but only if the bit flip actually made</span></span><br><span class="line"><span class="comment">         any difference - we don&#x27;t want no-op tokens. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (cksum != queue_cur-&gt;exec_cksum) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a_len &lt; MAX_AUTO_EXTRA) a_collect[a_len] = out_buf[stage_cur &gt;&gt; <span class="number">3</span>];</span><br><span class="line">        a_len++;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€éƒ¨åˆ†å°±æ˜¯AFLå°è¯•å»çŒœè§£tokenï¼Œæœ‰ç€ä¸€å®šå¯å‘å¼ã€‚<br>åœ¨è¿›è¡Œbitflip 1&#x2F;1å˜å¼‚æ—¶ï¼Œå¯¹äºæ¯ä¸ªbyte(å› ä¸ºæ¯ä¸€ä¸ªbyteéƒ½æ˜¯å…«ä½ï¼Œæ‰€ä»¥ä»£ç ä¸Šæ˜¯æ¯å…«ä½å¤„ç†ä¸€æ¬¡)çš„æœ€ä½ä½(least significant bit)ç¿»è½¬è¿˜è¿›è¡Œäº†é¢å¤–çš„å¤„ç†ï¼šå¦‚æœè¿ç»­å¤šä¸ªbytesçš„æœ€ä½ä½è¢«ç¿»è½¬åï¼Œç¨‹åºçš„æ‰§è¡Œè·¯å¾„éƒ½æœªå˜åŒ–ï¼Œè€Œä¸”ä¸åŸå§‹æ‰§è¡Œè·¯å¾„ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸€æ®µè¿ç»­çš„bytesåˆ¤æ–­æ˜¯ä¸€æ¡tokenã€‚è¿™é‡Œç”¨è·¯å¾„çš„hashæ¥åˆ¤æ–­æ˜¯å¦æ”¹å˜ã€‚<br>ä¾‹å¦‚ï¼ŒPNGæ–‡ä»¶ä¸­ç”¨IHDRä½œä¸ºèµ·å§‹å—çš„æ ‡è¯†ï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨ç±»ä¼¼äºä»¥ä¸‹çš„å†…å®¹<br>â€¦IHDRâ€¦<br>åœ¨æ‰§è¡Œ bitflip 1&#x2F;1 æ—¶ï¼Œå¦‚æœè¿ç»­ç¿»è½¬å¤šä¸ªå­—èŠ‚åçš„ç”¨ä¾‹ï¼Œéƒ½èƒ½è®©ç¨‹åºèµ°åˆ°æ–°çš„ä»£ç è·¯å¾„ï¼Œé‚£ä¹ˆå°±ç§°è¿ç»­ç¿»è½¬çš„å­—èŠ‚æ˜¯ä¸€ä¸ª tokenã€‚<br>å½“ç¿»è½¬åˆ°å­—ç¬¦Içš„æœ€é«˜ä½æ—¶ï¼Œå› ä¸ºIHDRè¢«ç ´åï¼Œæ­¤æ—¶ç¨‹åºçš„æ‰§è¡Œè·¯å¾„è‚¯å®šä¸å¤„ç†æ­£å¸¸æ–‡ä»¶çš„è·¯å¾„æ˜¯ä¸åŒçš„ï¼›éšåï¼Œåœ¨ç¿»è½¬æ¥ä¸‹æ¥3ä¸ªå­—ç¬¦çš„æœ€é«˜ä½æ—¶ï¼ŒIHDRæ ‡è¯†åŒæ ·è¢«ç ´åï¼Œç¨‹åºåº”è¯¥ä¼šé‡‡å–åŒæ ·çš„æ‰§è¡Œè·¯å¾„ã€‚ç”±æ­¤ï¼ŒAFLå°±åˆ¤æ–­å¾—åˆ°ä¸€ä¸ªå¯èƒ½çš„tokenï¼šIHDRï¼Œå¹¶å°†å…¶è®°å½•ä¸‹æ¥ä¸ºåé¢çš„å˜å¼‚æä¾›å¤‡é€‰ã€‚<br>åé¢çš„<code>bitflip2/1ã€4/1ã€1/1</code>æ˜¯åŒç†çš„ã€‚</p>
<p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒAFLåœ¨<code>bitflip8/8</code>è¿™é‡Œç»´æŠ¤äº†ä¸€ä¸ª<code>eff_map</code>ï¼Œè¿™ä¸ª<code>eff_map</code>æ˜¯å¯å‘å¼çš„ä¸€ä¸ªmapï¼Œæ˜¯ç²¾é«“æ‰€åœ¨ã€‚å…·ä½“å«ä¹‰æ˜¯ï¼šåœ¨å¯¹æ¯ä¸ª<code>byte</code>è¿›è¡Œç¿»è½¬æ—¶ï¼Œå¦‚æœå…¶é€ æˆæ‰§è¡Œè·¯å¾„ä¸æºè·¯å¾„ä¸ä¸€è‡´ï¼Œåˆ™å°†è¯¥<code>byte</code>åœ¨<code>eff_map</code>ä¸­æ ‡è®°ã€‚è¿™æ˜¯å› ä¸ºï¼šå¦‚æœä¸€ä¸ª<code>byte</code>å®Œå…¨ç¿»è½¬éƒ½ä¸èƒ½äº§ç”Ÿè·¯å¾„å˜åŒ–ï¼Œåˆ™è¿™ä¸ª<code>byte</code>æœ‰å¯èƒ½æ˜¯â€dataâ€ï¼Œå¯¹æ•´ä¸ªfuzzingæ„ä¹‰ä¸å¤§ï¼Œåœ¨ä¹‹åçš„ç¡®å®šæ€§å˜å¼‚ä¸­ï¼Œä¼šå‚è€ƒ<code>eff_map</code>è·³è¿‡æ— æ•ˆçš„å˜å¼‚ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!eff_map[EFF_APOS(stage_cur)]) &#123;</span><br><span class="line"></span><br><span class="line">  u32 cksum;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If in dumb mode or if the file is very short, just flag everything</span></span><br><span class="line"><span class="comment">     without wasting time on checksums. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode &amp;&amp; len &gt;= EFF_MIN_LEN)</span><br><span class="line">    cksum = hash32(trace_bits, MAP_SIZE, HASH_CONST);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    cksum = ~queue_cur-&gt;exec_cksum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cksum != queue_cur-&gt;exec_cksum) &#123;</span><br><span class="line">    eff_map[EFF_APOS(stage_cur)] = <span class="number">1</span>;</span><br><span class="line">    eff_cnt++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ARITHMETIC INC&#x2F;DEC</strong>é˜¶æ®µï¼Œæ•´æ•°åŠ å‡è¿ç®—<br>bitflip ç»“æŸä¹‹åï¼Œå°±è¿›å…¥ arithmetic é˜¶æ®µï¼Œç›®æ ‡å¤§å°å’Œé˜¶æ®µä¸ bitflip éå¸¸ç±»ä¼¼ï¼š</li>
</ul>
<p>arith 8&#x2F;8ï¼Œæ¯æ¬¡8bitè¿›è¡ŒåŠ å‡è¿ç®—ï¼Œ8bitæ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³å¯¹æ¯ä¸ªbyteè¿›è¡Œæ•´æ•°åŠ å‡å˜å¼‚ï¼›<br>arith 16&#x2F;8ï¼Œæ¯æ¬¡16bitè¿›è¡ŒåŠ å‡è¿ç®—ï¼Œ8bitæ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³å¯¹æ¯ä¸ªwordè¿›è¡Œæ•´æ•°åŠ å‡å˜å¼‚ï¼›<br>arith 32&#x2F;8ï¼Œæ¯æ¬¡32bitè¿›è¡ŒåŠ å‡è¿ç®—ï¼Œ8bitæ­¥é•¿ä»å¤´å¼€å§‹ï¼Œå³å¯¹æ¯ä¸ªdwordè¿›è¡Œæ•´æ•°åŠ å‡å˜å¼‚ï¼›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">stage_name  = <span class="string">&quot;arith 8/8&quot;</span>;<span class="comment">//8æ¯”ç‰¹çš„ç®—æœ¯å˜å¼‚</span></span><br><span class="line">stage_short = <span class="string">&quot;arith8&quot;</span>;</span><br><span class="line">stage_cur   = <span class="number">0</span>;</span><br><span class="line">stage_max   = <span class="number">2</span> * len * ARITH_MAX;</span><br><span class="line"></span><br><span class="line">stage_val_type = STAGE_VAL_LE;</span><br><span class="line"></span><br><span class="line">orig_hit_cnt = new_hit_cnt;<span class="comment">//å½“å‰è·¯å¾„è®¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;<span class="comment">//éå†æ¯ä¸ªå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">  u8 orig = out_buf[i];<span class="comment">//ä¿ç•™å­—èŠ‚çš„åŸå§‹å€¼</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let&#x27;s consult the effector map... */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!eff_map[EFF_APOS(i)]) &#123;<span class="comment">//å½“å‰å­—èŠ‚ä¸å†æœ‰æ•ˆå½±å“èŒƒå›´å†…</span></span><br><span class="line">  <span class="comment">//æ™ºèƒ½è·³è¿‡æŸäº›å˜å¼‚ï¼šå¦‚æœä¸€ä¸ªæ•´æ•°çš„æ‰€æœ‰byteséƒ½è¢«åˆ¤æ–­ä¸ºæ— æ•ˆï¼Œåˆ™è·³è¿‡ã€‚</span></span><br><span class="line">    stage_max -= <span class="number">2</span> * ARITH_MAX;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage_cur_byte = i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= ARITH_MAX; j++) &#123;</span><br><span class="line"></span><br><span class="line">    u8 r = orig ^ (orig + j);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do arithmetic operations only if the result couldn&#x27;t be a product</span></span><br><span class="line"><span class="comment">       of a bitflip. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!could_be_bitflip(r)) &#123;<span class="comment">//å¦‚æœç»“æœä¸å¯èƒ½æ˜¯æ¯”ç‰¹ç¿»è½¬çš„äº§ç‰©ï¼Œå³ä¸ä¼šäº§ç”Ÿæ— æ•ˆçš„å˜å¼‚ï¼Œå°±è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment">//æ™ºèƒ½è·³è¿‡ä¹‹å‰ç¿»è½¬å‘ç”Ÿçš„å˜å¼‚</span></span><br><span class="line">      stage_cur_val = j;<span class="comment">//è®°å½•å˜å¼‚çš„å€¼</span></span><br><span class="line">      out_buf[i] = orig + j;<span class="comment">//å˜å¼‚</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">      stage_cur++;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> stage_max--;</span><br><span class="line"></span><br><span class="line">    r =  orig ^ (orig - j);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!could_be_bitflip(r)) &#123;<span class="comment">//åŒä¸Š</span></span><br><span class="line"></span><br><span class="line">      stage_cur_val = -j;</span><br><span class="line">      out_buf[i] = orig - j;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">      stage_cur++;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> stage_max--;</span><br><span class="line"></span><br><span class="line">    out_buf[i] = orig;<span class="comment">//è¿˜åŸ</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_hit_cnt = queued_paths + unique_crashes;<span class="comment">//è®°å½•æ–°çš„è·¯å¾„è®¡æ•°</span></span><br><span class="line"></span><br><span class="line">stage_finds[STAGE_ARITH8]  += new_hit_cnt - orig_hit_cnt;<span class="comment">//è®°å½•å½“å‰é˜¶æ®µå‘ç°çš„è·¯å¾„æ•°é‡</span></span><br><span class="line">stage_cycles[STAGE_ARITH8] += stage_max;<span class="comment">//è®°å½•å½“å‰é˜¶æ®µå¤„ç†æ€»æ¬¡æ•°</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>INTERESTING VALUES</strong>é˜¶æ®µ<br>è¿™ä¸ªâ€interestingâ€ä»£è¡¨ç€ä¸€äº›ç‰¹æ®Šå€¼<br>ä¸è¿‡è¿™ä¸ªéƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±åªæ˜¯å°†éƒ¨åˆ†æ›¿æ¢æˆé¢„è®¾çš„â€interestingâ€éƒ¨åˆ†ã€‚<br>å…¶ä¸­è¦è·³è¿‡<code>eff_map</code>çš„ä»¥åŠä¹‹å‰å˜å¼‚è¿‡çš„ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">stage_name  = <span class="string">&quot;interest 8/8&quot;</span>;</span><br><span class="line">stage_short = <span class="string">&quot;int8&quot;</span>;</span><br><span class="line">stage_cur   = <span class="number">0</span>;</span><br><span class="line">stage_max   = len * <span class="keyword">sizeof</span>(interesting_8);</span><br><span class="line"></span><br><span class="line">stage_val_type = STAGE_VAL_LE;</span><br><span class="line"></span><br><span class="line">orig_hit_cnt = new_hit_cnt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Setting 8-bit integers. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line"></span><br><span class="line">  u8 orig = out_buf[i];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Let&#x27;s consult the effector map... */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!eff_map[EFF_APOS(i)]) &#123;</span><br><span class="line">    stage_max -= <span class="keyword">sizeof</span>(interesting_8);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage_cur_byte = i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="keyword">sizeof</span>(interesting_8); j++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Skip if the value could be a product of bitflips or arithmetics. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (could_be_bitflip(orig ^ (u8)interesting_8[j]) ||</span><br><span class="line">        could_be_arith(orig, (u8)interesting_8[j], <span class="number">1</span>)) &#123;</span><br><span class="line">      stage_max--;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage_cur_val = interesting_8[j];</span><br><span class="line">    out_buf[i] = interesting_8[j];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line">    out_buf[i] = orig;</span><br><span class="line">    stage_cur++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_hit_cnt = queued_paths + unique_crashes;</span><br><span class="line"></span><br><span class="line">stage_finds[STAGE_INTEREST8]  += new_hit_cnt - orig_hit_cnt;</span><br><span class="line">stage_cycles[STAGE_INTEREST8] += stage_max;</span><br></pre></td></tr></table></figure></li>
<li><strong>DICTIONARY STUFF</strong>é˜¶æ®µ<br>è¯¥é˜¶æ®µæ˜¯ç¡®å®šæ€§å˜å¼‚çš„å°¾å£°ï¼Œå¦‚æœç”¨æˆ·æä¾›çš„å­—å…¸é‡Œæœ‰<code>token</code>åˆ™æ›¿æ¢å˜å¼‚æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨<code>bitflip</code>äº§ç”Ÿçš„<code>token</code><br>è¯¥é˜¶æ®µåˆ†ä¸‰å°é˜¶æ®µï¼š</li>
</ul>
<ol>
<li>user extras (over)ï¼Œä»å¤´å¼€å§‹ï¼Œå°†ç”¨æˆ·æä¾›çš„tokensä¾æ¬¡æ›¿æ¢åˆ°åŸæ–‡ä»¶ä¸­ã€‚å¯¹äºç”¨æˆ·æä¾›çš„<code>token</code>ï¼ŒAFLä¼šä»å°åˆ°å¤§çš„æ’ï¼Œè¿™æ ·åœ¨æ›¿æ¢çš„æ—¶å€™åé¢çš„<code>token</code>ä¸ä¼šæ¯”å‰é¢çš„çŸ­ï¼Œçœå»äº†è¿˜åŸçš„æ­¥éª¤ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">stage_name  = <span class="string">&quot;user extras (over)&quot;</span>;</span><br><span class="line">stage_short = <span class="string">&quot;ext_UO&quot;</span>;</span><br><span class="line">stage_cur   = <span class="number">0</span>;</span><br><span class="line">stage_max   = extras_cnt * len;</span><br><span class="line"></span><br><span class="line">stage_val_type = STAGE_VAL_NONE;</span><br><span class="line"></span><br><span class="line">orig_hit_cnt = new_hit_cnt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line"></span><br><span class="line">  u32 last_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  stage_cur_byte = i;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Extras are sorted by size, from smallest to largest. This means</span></span><br><span class="line"><span class="comment">     that we don&#x27;t have to worry about restoring the buffer in</span></span><br><span class="line"><span class="comment">     between writes at a particular offset determined by the outer</span></span><br><span class="line"><span class="comment">     loop. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; extras_cnt; j++) &#123;<span class="comment">//éå†ç”¨æˆ·token</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Skip extras probabilistically if extras_cnt &gt; MAX_DET_EXTRAS. Also</span></span><br><span class="line"><span class="comment">       skip them if there&#x27;s no room to insert the payload, if the token</span></span><br><span class="line"><span class="comment">       is redundant, or if its entire span has no bytes set in the effector</span></span><br><span class="line"><span class="comment">       map. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((extras_cnt &gt; MAX_DET_EXTRAS &amp;&amp; UR(extras_cnt) &gt;= MAX_DET_EXTRAS) ||</span><br><span class="line">        extras[j].len &gt; len - i ||</span><br><span class="line">        !<span class="built_in">memcmp</span>(extras[j].data, out_buf + i, extras[j].len) ||</span><br><span class="line">        !<span class="built_in">memchr</span>(eff_map + EFF_APOS(i), <span class="number">1</span>, EFF_SPAN_ALEN(i, extras[j].len))) &#123;<span class="comment">//å¦‚æœTokenæ•°é‡å¤ªå¤šï¼Œå°±éœ€è¦æ ¹æ®è¿™äº›æ¡ä»¶è¿›è¡Œæœ‰æ¦‚ç‡çš„è·³è¿‡</span></span><br><span class="line"></span><br><span class="line">      stage_max--;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    last_len = extras[j].len;</span><br><span class="line">    <span class="built_in">memcpy</span>(out_buf + i, extras[j].data, last_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line">    stage_cur++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Restore all the clobbered memory. */</span></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf + i, in_buf + i, last_len);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_hit_cnt = queued_paths + unique_crashes;</span><br><span class="line"></span><br><span class="line">stage_finds[STAGE_EXTRAS_UO]  += new_hit_cnt - orig_hit_cnt;</span><br><span class="line">stage_cycles[STAGE_EXTRAS_UO] += stage_max;</span><br></pre></td></tr></table></figure></li>
<li>user extras (insert)ï¼Œuser extras (insert)æ˜¯å¯¹ç”¨æˆ·æä¾›çš„tokensæ‰§è¡Œæ’å…¥å˜å¼‚ï¼Œä¸user extras (over)ä¸åŒï¼Œç”±äºåŸæ–‡ä»¶å¹¶æœªå‘ç”Ÿæ›¿æ¢ï¼Œeffector mapåœ¨è¿™é‡Œä¸å†è¢«ä½¿ç”¨äº†ã€‚å¹¶ä¸”æ­¤æ—¶å¹¶æ²¡æœ‰å¯¹tokensæ•°é‡çš„é™åˆ¶ï¼Œæ‰€ä»¥å…¨éƒ¨tokenséƒ½ä¼šä»åŸæ–‡ä»¶çš„ç¬¬1ä¸ªbyteå¼€å§‹ï¼Œä¾æ¬¡å‘åæ’å…¥ã€‚è¿™ä¸€å­é˜¶æ®µæœ€ç‰¹åˆ«çš„åœ°æ–¹ï¼Œå°±æ˜¯å˜å¼‚ä¸èƒ½ç®€å•åœ°æ¢å¤ã€‚ä¹‹å‰æ¯æ¬¡å˜å¼‚å®Œï¼Œåœ¨å˜å¼‚ä½ç½®å¤„ç®€å•å–é€†å³å¯ï¼Œä¾‹å¦‚bitflipåï¼Œå†è¿›è¡Œä¸€æ¬¡åŒæ ·çš„bitflipå°±æ¢å¤ä¸ºåŸæ–‡ä»¶ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œä¹‹å‰çš„å˜å¼‚æ€»ä½“è¿ç®—é‡å¹¶ä¸å¤§ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">stage_name  = <span class="string">&quot;user extras (insert)&quot;</span>;</span><br><span class="line">stage_short = <span class="string">&quot;ext_UI&quot;</span>;</span><br><span class="line">stage_cur   = <span class="number">0</span>;</span><br><span class="line">stage_max   = extras_cnt * (len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">orig_hit_cnt = new_hit_cnt;</span><br><span class="line"></span><br><span class="line">ex_tmp = ck_alloc(len + MAX_DICT_FILE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= len; i++) &#123;</span><br><span class="line"></span><br><span class="line">  stage_cur_byte = i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; extras_cnt; j++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len + extras[j].len &gt; MAX_FILE) &#123;</span><br><span class="line">      stage_max--;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Insert token */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(ex_tmp + i, extras[j].data, extras[j].len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy tail */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(ex_tmp + i + extras[j].len, out_buf + i, len - i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, ex_tmp, len + extras[j].len)) &#123;</span><br><span class="line">      ck_free(ex_tmp);</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage_cur++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Copy head */</span></span><br><span class="line">  ex_tmp[i] = out_buf[i];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ck_free(ex_tmp);</span><br><span class="line"></span><br><span class="line">new_hit_cnt = queued_paths + unique_crashes;</span><br><span class="line"></span><br><span class="line">stage_finds[STAGE_EXTRAS_UI]  += new_hit_cnt - orig_hit_cnt;</span><br><span class="line">stage_cycles[STAGE_EXTRAS_UI] += stage_max;</span><br></pre></td></tr></table></figure></li>
<li>auto extras (over),è¿™ä¸€é¡¹ä¸â€user extras (over)â€å¾ˆç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼Œè¿™é‡Œçš„tokensæ˜¯æœ€å¼€å§‹bitflipé˜¶æ®µè‡ªåŠ¨ç”Ÿæˆçš„ã€‚å¦å¤–ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„tokensæ€»é‡ä¼šç”±USE_AUTO_EXTRASé™åˆ¶ï¼ˆé»˜è®¤ä¸º128ï¼‰ã€‚ä»£ç å°±ä¸è´´äº†<br>è‡³æ­¤ï¼Œç¡®å®šæ€§å˜å¼‚å°±ç»“æŸäº†ï¼Œä¸‹é¢å¼€å§‹éç¡®å®šæ€§å˜å¼‚ã€‚</li>
</ol>
<ul>
<li><strong>HAVOC</strong>é˜¶æ®µ<br>havocè‹±æ–‡é‡Šä¹‰æ˜¯â€æ··æ²Œâ€œï¼Œåœ¨è¿™é‡Œhavocï¼Œæ˜¯å¯¹åŸæ–‡ä»¶çš„â€œå¤§ç ´åâ€ã€‚å…·ä½“æ¥è¯´ï¼ŒhavocåŒ…å«äº†å¯¹åŸæ–‡ä»¶çš„å¤šè½®å˜å¼‚ï¼Œæ¯ä¸€è½®éƒ½æ˜¯å°†å¤šç§æ–¹å¼ç»„åˆï¼ˆstackedï¼‰è€Œæˆã€‚<br>åœ¨è¿™ä¸€é˜¶æ®µä¸­ï¼Œå…±æœ‰åå…­ç§éšæœºå˜å¼‚ã€‚äº‹å®ä¸Šï¼Œhavocä¼šå¯¹åŸæ–‡ä»¶è¿›è¡Œå¤šè½®å˜å¼‚ï¼Œæ¯ä¸€è½®éƒ½æ˜¯å¤šç§æ–¹å¼ç»„åˆã€‚ä»£ç ä¸å…¨è´´ã€‚AFLä¼šç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œä½œä¸ºå˜å¼‚ç»„åˆçš„æ•°é‡ï¼Œå¹¶æ ¹æ®è¿™ä¸ªæ•°é‡ï¼Œæ¯æ¬¡ä»ä¸Šé¢é‚£äº›æ–¹å¼ä¸­éšæœºé€‰å–ä¸€ä¸ªï¼ˆå¯ä»¥å‚è€ƒé«˜ä¸­æ•°å­¦çš„æœ‰æ”¾å›æ‘¸çƒï¼‰ï¼Œä¾æ¬¡ä½œç”¨åˆ°æ–‡ä»¶ä¸Šã€‚å¦‚æ­¤è¿™èˆ¬ä¸§å¿ƒç—…ç‹‚çš„å˜å¼‚ï¼ŒåŸæ–‡ä»¶å°±å¤§æ¦‚ç‡é¢ç›®å…¨éäº†ï¼Œè€Œè¿™ä¹ˆå¤šçš„éšæœºæ€§ï¼Œä¹Ÿå°±æˆäº†fuzzingè¿‡ç¨‹ä¸­çš„ä¸å¯æ§å› ç´ ï¼Œå³æ‰€è°“çš„â€œçœ‹å¤©åƒé¥­â€äº†</li>
<li><strong>SPLICING</strong>é˜¶æ®µ<br>æ­¤ä¸ºæœ€åçš„é˜¶æ®µï¼Œæ˜¯å°†ä¸¤ä¸ªseedæ‹¼æ¥å¾—åˆ°æ–°çš„æ–‡ä»¶ï¼Œå¯¹è¿™ä¸ªæ–°æ–‡ä»¶ç»§ç»­è¿›è¡Œhavocå˜å¼‚ã€‚<br>å…·ä½“åœ°ï¼ŒAFLåœ¨seedæ–‡ä»¶é˜Ÿåˆ—ä¸­éšæœºé€‰å–ä¸€ä¸ªï¼Œä¸å½“å‰çš„seedæ–‡ä»¶åšå¯¹æ¯”ã€‚<br><code>if (f_diff &lt; 0 || l_diff &lt; 2 || f_diff == l_diff) &#123; goto retry_splicing; &#125;</code>å¦‚æœä¸¤è€…å·®åˆ«ä¸å¤§ï¼Œå°±å†é‡æ–°éšæœºé€‰ä¸€ä¸ªï¼›å¦‚æœä¸¤è€…ç›¸å·®æ¯”è¾ƒæ˜æ˜¾ï¼Œé‚£ä¹ˆå°±éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œ<code>split_at = f_diff + rand_below(afl, l_diff - f_diff);</code>å°†ä¸¤è€…éƒ½åˆ†å‰²ä¸ºå¤´éƒ¨å’Œå°¾éƒ¨ã€‚æœ€åï¼Œå°†å½“å‰æ–‡ä»¶çš„å¤´éƒ¨ä¸éšæœºæ–‡ä»¶çš„å°¾éƒ¨æ‹¼æ¥èµ·æ¥ï¼Œå°±å¾—åˆ°äº†æ–°çš„æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼ŒAFLè¿˜ä¼šè¿‡æ»¤æ‰æ‹¼æ¥æ–‡ä»¶æœªå‘ç”Ÿå˜åŒ–çš„æƒ…å†µã€‚</li>
</ul>
<p>ä¸Šé¢çš„å˜å¼‚å®Œæˆåï¼ŒAFLä¼šå¯¹æ–‡ä»¶é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªè¿›è¡Œå˜å¼‚å¤„ç†ã€‚å½“é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨æ–‡ä»¶éƒ½å˜å¼‚æµ‹è¯•åï¼Œå°±å®Œæˆäº†ä¸€ä¸ªâ€cycleâ€ï¼Œè¿™ä¸ªå°±æ˜¯AFLçŠ¶æ€æ å³ä¸Šè§’çš„â€cycles doneâ€ã€‚è€Œæ­£å¦‚cycleçš„æ„æ€æ‰€è¯´ï¼Œæ•´ä¸ªé˜Ÿåˆ—åˆä¼šä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ï¼Œå†æ¬¡è¿›è¡Œå˜å¼‚ï¼Œä¸è¿‡ä¸ç¬¬ä¸€æ¬¡å˜å¼‚ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸€æ¬¡å°±ä¸éœ€è¦å†è¿›è¡Œdeterministic fuzzingäº†ã€‚</p>
<p>é‚£ä¹ˆåˆ°è¿™é‡Œï¼Œfuzz.cæ–‡ä»¶çš„æ•´ä½“æ¡†æ¶å’Œé€»è¾‘å°±è¿™ä¹ˆå¤šäº†ã€‚æœ‰äº›é€šä¿¡ä¸Šçš„ç»†èŠ‚å¯èƒ½è¿˜æ²¡å¼„å®Œå…¨ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†å†…å®¹æ˜¯å·®ä¸å¤šäº†ã€‚<br>æ€»ç»“æ¥è¯´ï¼ŒAFLåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•å™¨ï¼Œå®ƒçš„é€»è¾‘è¿˜ç®—æ¯”è¾ƒæ¸…æ¥šæ˜æœ—ï¼Œæºç çš„æ„æˆä¹Ÿç›¸å¯¹æ¸…æ¥šã€‚ä¸è¿‡è¿™æ¬¡è¿˜æ²¡çœ‹å®Œllvmæ¨¡å¼ä¸‹çš„æ’æ¡©ï¼Œä¹‹åå†çœ‹å§ã€‚çœ‹æºç è¿›è¡Œå­¦ä¹ ç¡®å®äº‹åŠåŠŸå€ï¼Œç»éªŒå°±æ˜¯è·Ÿç€ä¸»å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸€æ­¥æ­¥çš„æ‹†è§£ä»£ç ï¼Œåˆ†æè¿‡ç¨‹ï¼Œè€ƒå¯Ÿå…³é”®å‡½æ•°å°±è¡Œã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/AFL/" rel="tag"># AFL</a>
              <a href="/tags/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/" rel="tag"># æ¨¡ç³Šæµ‹è¯•</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/03/01/AFL%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84Q-A/" rel="prev" title="AFLå­¦ä¹ ä¸­çš„Q&A">
      <i class="fa fa-chevron-left"></i> AFLå­¦ä¹ ä¸­çš„Q&A
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/03/04/peach%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%BF%E7%94%A8/" rel="next" title="peachåŸç†å’Œä½¿ç”¨">
      peachåŸç†å’Œä½¿ç”¨ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#afl-gcc-c"><span class="nav-number">1.</span> <span class="nav-text">afl-gcc.c</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#find-as"><span class="nav-number">1.0.1.</span> <span class="nav-text">find_as</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#edit-params"><span class="nav-number">1.0.2.</span> <span class="nav-text">edit_params</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main"><span class="nav-number">1.0.3.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#edit-params-1"><span class="nav-number">1.0.4.</span> <span class="nav-text">edit_params</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#add-instructmentation"><span class="nav-number">1.0.5.</span> <span class="nav-text">add_instructmentation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main-1"><span class="nav-number">1.0.6.</span> <span class="nav-text">main</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#afl-clang-fast"><span class="nav-number">2.</span> <span class="nav-text">afl-clang-fast</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#afl-fuzz-c"><span class="nav-number">3.</span> <span class="nav-text">afl-fuzz.c</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-2"><span class="nav-number">3.0.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#perform-dry-run"><span class="nav-number">3.0.2.</span> <span class="nav-text">perform_dry_run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#calibrate-case"><span class="nav-number">3.0.3.</span> <span class="nav-text">calibrate_case</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update-bitmap-score"><span class="nav-number">3.0.4.</span> <span class="nav-text">update_bitmap_score</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fuzz%E6%89%A7%E8%A1%8C"><span class="nav-number">3.1.</span> <span class="nav-text">fuzzæ‰§è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cull-queue-%E4%B8%BB%E5%BE%AA%E7%8E%AF%E5%89%8D"><span class="nav-number">3.1.1.</span> <span class="nav-text">cull_queue(ä¸»å¾ªç¯å‰)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%BE%AA%E7%8E%AF-8091"><span class="nav-number">3.1.2.</span> <span class="nav-text">ä¸»å¾ªç¯(8091)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fuzz-one"><span class="nav-number">3.1.3.</span> <span class="nav-text">fuzz_one</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sparrow"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Sparrow</p>
  <div class="site-description" itemprop="description">ä¸çŸ¥æ‰€æªæ‰æ˜¯äººç”Ÿ</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huamuyichun" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;huamuyichun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2486013181@qq.com" title="E-Mail â†’ mailto:2486013181@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/hejiawenze" title="Google â†’ https:&#x2F;&#x2F;plus.google.com&#x2F;hejiawenze" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2023-04 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sparrow</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">åšå®¢å…¨ç«™å…±31.7kå­—</span>
</div>
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  















  

  

  

</body>
</html>
